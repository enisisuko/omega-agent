# ICEE Agent — 代码管家（总索引）

> 最后更新：2026-02-22  v0.2.3

## 项目结构

```
ICeeAgent/
├── apps/
│   └── desktop/                    # Electron 桌面应用（主体）
│       ├── src/
│       │   ├── main/
│       │   │   └── index.ts        # Electron 主进程，IPC 处理，Runtime 初始化
│       │   ├── preload/
│       │   │   └── index.ts        # contextBridge 预加载脚本
│       │   └── renderer/           # React 渲染进程
│       │       ├── App.tsx         # 应用根组件，会话状态管理，IPC 通信
│       │       ├── types/
│       │       │   ├── ui.ts       # UI 数据类型定义（含 ExecutionRound, ConversationSession 等）
│       │       │   └── electron.d.ts # window.icee API 类型声明
│       │       ├── hooks/
│       │       │   ├── useIceeRuntime.ts    # IPC 事件监听 Hook
│       │       │   ├── useLayoutEngine.ts   # BFS 拓扑排序布局引擎（含 yOffset 多轮支持）
│       │       │   └── useDraggableCanvas.ts # 画布拖拽 Hook（v0.2.2 新增）
│       │       ├── components/
│       │       │   ├── nerve-center/
│       │       │   │   ├── NerveCenter.tsx   # 核心画布（拖拽+多轮渲染，v0.2.2 重构）
│       │       │   │   ├── OrchestratorNode.tsx # 大脑节点
│       │       │   │   ├── SubagentCard.tsx  # 执行节点卡片（可展开）
│       │       │   │   ├── DataPipe.tsx      # 数据管道（独立 SVG）
│       │       │   │   ├── NodeDetailPanel.tsx  # 节点展开详情
│       │       │   │   ├── RerunModal.tsx    # 重跑提示词编辑弹窗
│       │       │   │   ├── TaskInputBar.tsx  # 任务输入栏
│       │       │   │   ├── AiOutputCard.tsx  # AI 回复卡片
│       │       │   │   ├── ResourceSubstrate.tsx # 底部资源层
│       │       │   │   └── TraceLogDrawer.tsx # 右侧 Trace 日志抽屉
│       │       │   ├── layout/
│       │       │   │   └── Sidebar.tsx       # 侧边栏（会话列表+导航）
│       │       │   └── pages/
│       │       │       ├── SettingsPage.tsx  # 设置页（Provider/MCP 管理，v0.2.2 修复表单重置）
│       │       │       └── ArtifactsPage.tsx # 历史记录页
│       │       ├── data/
│       │       │   └── mockData.ts           # Mock 数据
│       │       └── i18n/
│       │           ├── LanguageContext.tsx   # 国际化 Context
│       │           └── translations.ts       # 中/英翻译字典
├── packages/
│   ├── shared/                    # 共享 Schema（Zod）
│   ├── core/                      # 运行时核心
│   │   ├── runtime.ts             # GraphRuntime（run/forkRun/replay）
│   │   ├── executors/             # 节点执行器（LLM/Input/Output）
│   │   └── providers/             # LLM Provider（OllamaProvider/OpenAICompatibleProvider）
│   └── db/
│       ├── src/
│       │   ├── schema.ts          # SQLite DDL（v0.2.2 补充 api_key/model 列）
│       │   └── database.ts        # DB 连接管理（v0.2.2 加 migrateProviders 自动迁移）
│       └── ...
└── 代码管家.md                     # 本文件
```

---

## 版本变更记录

### v0.2.3 — Provider 保存彻底修复 + 弹窗层级

**根本原因修复：**
1. **IPC 竞态**：`icee:list-providers` / `save-provider` / `delete-provider` / `reload-provider` 原来注册在 `initRuntime()` 内部（异步，窗口 ready 后才执行），导致渲染进程启动时调用这些 IPC 报 "No handler registered" 错误。现在将这 4 个 handler 通过新函数 `registerProviderHandlers()` 提前到 `app.whenReady` 时注册，不再依赖 runtime 就绪。
2. **模型硬编码**：`App.tsx` 中 graphJson 的 LLM 节点 config 写死了 `model: "llama3.2"`，导致即使在设置中切换了 Provider，执行时仍用旧模型。现在删除该字段，`LLMNodeExecutor` fallback 到 `globalProviderRef.model`（主进程当前配置的模型）。
3. **弹窗层级**：`SettingsPage` 最外层加 `relative`，`ProviderFormDrawer` 遮罩从 `z-10` 升为 `z-50`，面板从 `z-20` 升为 `z-[60]`，确保弹窗正确置顶。

**架构变化（main/index.ts）：**
- 新增模块级 `globalProviderRef`（替代 initRuntime 内部局部 `providerRef`）
- 新增模块级 `earlyDbRef` + `ensureEarlyDb()` 懒初始化函数
- 新增 `registerProviderHandlers()` 函数，在 `app.whenReady` 时调用

### v0.2.2 — 画布拖拽 + 多轮对话 + Provider 保存修复

**修复问题：**
1. **Provider 保存无效**
   - `packages/db/src/schema.ts`：`providers` 表补充 `api_key` 和 `model` 列
   - `packages/db/src/database.ts`：新增 `migrateProviders()` 方法，启动时自动 `ALTER TABLE` 为旧 DB 补列
   - `SettingsPage.tsx`：`ProviderFormDrawer` 用 `useEffect` 替换 `useState` 初始值，切换/重开表单时字段正确刷新

**新功能：**
2. **画布可拖拽**
   - 新增 `apps/desktop/src/renderer/hooks/useDraggableCanvas.ts`
   - 鼠标左键拖拽平移，双击重置到原点，节点卡片阻止事件冒泡
   - `NerveCenter.tsx` 的 Middle 容器绑定拖拽 Handler，内层加 transform 容器

3. **多轮对话支持**
   - `types/ui.ts`：新增 `ExecutionRound` 接口，`ConversationSession` 添加 `rounds: ExecutionRound[]` 字段
   - `useLayoutEngine.ts`：新增 `yOffset` 参数，多轮图垂直续接
   - `NerveCenter.tsx`：接收 `rounds` prop，多轮垂直渲染，历史轮半透明，带轮次分隔线
   - `App.tsx`：`handleTaskSubmit` 改为追加 `ExecutionRound`，`onStepEvent`/`onRunCompleted` 同步更新最新轮

---

### v0.2.1 — 全面打通

- `forkRun` IPC 接通（preload/main/renderer）
- 真实 MCP 工具数据接入
- 空画布引导提示

### v0.2.0 — 节点展开/撤回/重跑

- `NodeDetailPanel.tsx`、`RerunModal.tsx` 新增
- `SubagentCard` 可展开显示步骤历史

### v0.1.9 — 动态图可视化

- `ExecutionEdge` 接口、`useLayoutEngine` BFS 布局
- `DataPipe` SVG 贝塞尔曲线动画连线

### v0.1.8 — 真实数据打通

- IPC 事件驱动 trace log、subagents、orchestrator 状态

### v0.1.7 — MCP + 文件/图片上传

### v0.1.6 — 多会话 UI + Electron IPC

### v0.1.5 — Ollama CLI 接入

### v0.1.0 — 初始实现

---

## 关键类型（types/ui.ts）

| 类型 | 说明 |
|------|------|
| `ExecutionRound` | 单轮对话执行图（roundIndex, task, edges, subagents, aiOutput） |
| `ConversationSession` | 会话（含 `rounds: ExecutionRound[]`，向下兼容顶层字段） |
| `SubagentNode` | 单个执行节点状态 |
| `ExecutionEdge` | 有向执行边（pending/active/completed/failed） |
| `NodeStepRecord` | 节点内单步执行记录（供展开面板使用） |
| `TraceLogEntry` | Trace 日志条目 |

---

## 关键 IPC 通道

| 通道 | 方向 | 说明 |
|------|------|------|
| `icee:run-graph` | invoke | 执行图 |
| `icee:fork-run` | invoke | Fork 重跑 |
| `icee:reload-provider` | invoke | 热重载 Provider 配置 |
| `icee:save-provider` | invoke | 保存 Provider 到 DB |
| `icee:list-providers` | invoke | 列出所有 Providers |
| `icee:step-event` | on（主→渲染） | 步骤事件推送 |
| `icee:run-completed` | on（主→渲染） | Run 完成推送 |
| `icee:ollama-status` | on（主→渲染） | Ollama 健康状态推送 |
