# ICEE Agent — 代码管家（总索引）

> 最后更新：2026-02-22  v0.3.7（GitHub 开源项目完善）

## 项目结构

```
ICeeAgent/
├── apps/
│   └── desktop/                    # Electron 桌面应用（主体）
│       ├── build-resources/
│       │   └── icon.ico            # 应用图标（打包用）
│       ├── src/
│       │   ├── main/
│       │   │   ├── index.ts        # Electron 主进程，IPC 处理，Runtime 初始化（v0.3.4: 全静态 import）
│       │   │   └── mcp/
│       │   │       ├── McpClientManager.ts  # MCP filesystem server 客户端管理
│       │   │       └── BuiltinMcpTools.ts   # 内置 MCP 工具集（web_search/http_fetch/browser_open/clipboard）
│       │   ├── preload/
│       │   │   └── index.ts        # contextBridge 预加载脚本
│       │   └── renderer/           # React 渲染进程
│       │       ├── App.tsx         # 应用根组件，会话状态管理，IPC 通信
│       │       ├── types/
│       │       │   ├── ui.ts       # UI 数据类型定义（含 ExecutionRound, ConversationSession 等）
│       │       │   └── electron.d.ts # window.icee API 类型声明
│       │       ├── hooks/
│       │       │   ├── useIceeRuntime.ts    # IPC 事件监听 Hook
│       │       │   ├── useLayoutEngine.ts   # BFS 拓扑排序布局引擎（含 yOffset 多轮支持）
│       │       │   └── useDraggableCanvas.ts # 画布拖拽 Hook（v0.2.2 新增）
│       │       ├── components/
│       │       │   ├── nerve-center/
│       │       │   │   ├── NerveCenter.tsx   # 核心画布（拖拽+多轮渲染，v0.2.2 重构）
│       │       │   │   ├── OrchestratorNode.tsx # 大脑节点
│       │       │   │   ├── SubagentCard.tsx  # 执行节点卡片（可展开）
│       │       │   │   ├── DataPipe.tsx      # 数据管道（独立 SVG）
│       │       │   │   ├── NodeDetailPanel.tsx  # 节点展开详情
│       │       │   │   ├── RerunModal.tsx    # 重跑提示词编辑弹窗
│       │       │   │   ├── TaskInputBar.tsx  # 任务输入栏
│       │       │   │   ├── AiOutputCard.tsx  # AI 回复卡片
│       │       │   │   ├── ResourceSubstrate.tsx # 底部资源层
│       │       │   │   └── TraceLogDrawer.tsx # 右侧 Trace 日志抽屉
│       │       │   ├── layout/
│       │       │   │   └── Sidebar.tsx       # 侧边栏（会话列表+导航）
│       │       │   └── pages/
│       │       │       ├── SettingsPage.tsx  # 设置页（Provider/MCP 管理，v0.2.2 修复表单重置）
│       │       │       └── ArtifactsPage.tsx # 历史记录页
│       │       ├── data/
│       │       │   └── mockData.ts           # Mock 数据
│       │       └── i18n/
│       │           ├── LanguageContext.tsx   # 国际化 Context
│       │           └── translations.ts       # 中/英翻译字典
├── packages/
│   ├── shared/                    # 共享 Schema（Zod）
│   ├── core/                      # 运行时核心
│   │   ├── runtime.ts             # GraphRuntime（run/forkRun/replay）
│   │   ├── executors/             # 节点执行器（LLM/Input/Output）
│   │   └── providers/             # LLM Provider（OllamaProvider/OpenAICompatibleProvider）
│   └── db/
│       ├── src/
│       │   ├── schema.ts          # SQLite DDL（v0.2.2 补充 api_key/model 列）
│       │   └── database.ts        # DB 连接管理（v0.2.2 加 migrateProviders 自动迁移）
│       └── ...
└── 代码管家.md                     # 本文件
```

---

## 版本变更记录

### v0.3.7 — GitHub 开源项目完善

**新增文件**：
- **`.github/workflows/ci.yml`**（新增）：GitHub Actions CI，pnpm install + build packages + lint，push/PR 时自动运行
- **`CHANGELOG.md`**（新增）：完整版本更新历史，从 v0.1.0 到 v0.3.6，遵循 Keep a Changelog 规范
- **`CODE_OF_CONDUCT.md`**（新增）：基于 Contributor Covenant 的行为准则
- **`SECURITY.md`**（新增）：安全漏洞私下报告流程指引
- **`.github/PULL_REQUEST_TEMPLATE.md`**（新增）：PR 提交模板

**清理**：
- `cursor-output/` 和 `cursor输出/` 从 git 追踪移除（`git rm --cached`）
- `.gitignore` 添加这两个目录规则

**分支修复**：
- `master` 内容合并到 `main`（强制推送），GitHub 默认分支已为 `main`

---

### v0.3.5 — GitHub 仓库文档完善

**新增文件**：
- **`README.md`**（全部重写）：英文版主页，基于真实代码重写，包含截图引用、真实功能列表、Quick Start、Provider 配置表格、项目结构、节点类型、内置工具、技术栈、路线图
- **`README.zh.md`**（新增）：完整中文版 README，与英文版内容完全对应，面向中文用户社区
- **`CONTRIBUTING.md`**（新增）：开发环境搭建指南、如何新增 Provider / 节点执行器 / 内置工具、代码风格规范、Conventional Commits 提交规范、PR 流程
- **`.github/ISSUE_TEMPLATE/bug_report.md`**（新增）：Bug 报告模板（含 OS/Electron/Node/Provider/Model 环境信息）
- **`.github/ISSUE_TEMPLATE/feature_request.md`**（新增）：功能请求模板

---

### v0.2.3 — Provider 保存彻底修复 + 弹窗层级

**根本原因修复：**
1. **IPC 竞态**：`icee:list-providers` / `save-provider` / `delete-provider` / `reload-provider` 原来注册在 `initRuntime()` 内部（异步，窗口 ready 后才执行），导致渲染进程启动时调用这些 IPC 报 "No handler registered" 错误。现在将这 4 个 handler 通过新函数 `registerProviderHandlers()` 提前到 `app.whenReady` 时注册，不再依赖 runtime 就绪。
2. **模型硬编码**：`App.tsx` 中 graphJson 的 LLM 节点 config 写死了 `model: "llama3.2"`，导致即使在设置中切换了 Provider，执行时仍用旧模型。现在删除该字段，`LLMNodeExecutor` fallback 到 `globalProviderRef.model`（主进程当前配置的模型）。
3. **弹窗层级**：`SettingsPage` 最外层加 `relative`，`ProviderFormDrawer` 遮罩从 `z-10` 升为 `z-50`，面板从 `z-20` 升为 `z-[60]`，确保弹窗正确置顶。

**架构变化（main/index.ts）：**
- 新增模块级 `globalProviderRef`（替代 initRuntime 内部局部 `providerRef`）
- 新增模块级 `earlyDbRef` + `ensureEarlyDb()` 懒初始化函数
- 新增 `registerProviderHandlers()` 函数，在 `app.whenReady` 时调用

### v0.2.2 — 画布拖拽 + 多轮对话 + Provider 保存修复

**修复问题：**
1. **Provider 保存无效**
   - `packages/db/src/schema.ts`：`providers` 表补充 `api_key` 和 `model` 列
   - `packages/db/src/database.ts`：新增 `migrateProviders()` 方法，启动时自动 `ALTER TABLE` 为旧 DB 补列
   - `SettingsPage.tsx`：`ProviderFormDrawer` 用 `useEffect` 替换 `useState` 初始值，切换/重开表单时字段正确刷新

**新功能：**
2. **画布可拖拽**
   - 新增 `apps/desktop/src/renderer/hooks/useDraggableCanvas.ts`
   - 鼠标左键拖拽平移，双击重置到原点，节点卡片阻止事件冒泡
   - `NerveCenter.tsx` 的 Middle 容器绑定拖拽 Handler，内层加 transform 容器

3. **多轮对话支持**
   - `types/ui.ts`：新增 `ExecutionRound` 接口，`ConversationSession` 添加 `rounds: ExecutionRound[]` 字段
   - `useLayoutEngine.ts`：新增 `yOffset` 参数，多轮图垂直续接
   - `NerveCenter.tsx`：接收 `rounds` prop，多轮垂直渲染，历史轮半透明，带轮次分隔线
   - `App.tsx`：`handleTaskSubmit` 改为追加 `ExecutionRound`，`onStepEvent`/`onRunCompleted` 同步更新最新轮

---

### v0.2.7 — Provider DB 列迁移修复（彻底解决 llama3.2 硬编码问题）

**根本原因**：通过直接查询 `Electron\icee.db`，发现 providers 表缺少 `api_key` 和 `model` 两列（旧 schema 建表时没有这两列）。`save-provider` 的 INSERT 语句引用这两列导致 SQLite 报错，catch 静默吞掉，DB 始终为空，每次 run 都 fallback `llama3.2`。

**修复内容**：
- **`apps/desktop/src/main/index.ts`**：`ensureEarlyDb()` 函数获取 DB 实例后立即执行 `ALTER TABLE providers ADD COLUMN api_key TEXT` 和 `ADD COLUMN model TEXT`，区分「列已存在（跳过）」vs「真正失败」。无论 DB 是新建还是旧文件，列一定存在。
- **`packages/db/src/database.ts`**：`migrateProviders()` 改进日志，区分「duplicate column（正常跳过）」vs「真正异常（打 error）」。
- **`apps/desktop/src/renderer/App.tsx`**：`handleSaveProvider` 在 `result.error` 时将错误写入 trace log，用户在 UI 可见。

---

### v0.2.6 — LLM 每次调用实时读取 DB Provider

**根本问题**：`LLMNodeExecutor` 在 initRuntime 时创建一次 provider instance 并缓存在 `globalProviderRef`，但用户第一次配置 provider 时 initRuntime 已经用了默认 Ollama；`reload-provider` 热重载虽然设计存在，但时序问题（instance 可能为 null）导致替换失败。

**修复**：彻底改变策略 — LLMNodeExecutor 的 callback 每次被调用时都从 DB 实时查询最新的默认 Provider，动态创建实例并同步更新 `globalProviderRef`。这样无论 reload 时序如何，每次 Run 都用最新配置。

**改动**：`apps/desktop/src/main/index.ts` LLMNodeExecutor callback 完全重写，加入实时 DB 读取 + 详细日志。

---

### v0.2.5 — LLMNodeExecutor 校验修复 + list-runs 早期注册

**根本问题一**：`packages/core/src/executor/builtins/LLMNodeExecutor.ts` 第 26 行强制 `if (!config?.provider || !config?.model) throw Error`，
但 v0.2.3 起 graphJson 故意不携带 `model`/`provider`（让主进程 `globalProviderRef` 决定），导致每次 Run 直接报错。

**修复内容一**：
- `packages/core/src/executor/builtins/LLMNodeExecutor.ts`：去掉 `provider`/`model` 必填校验，只要有 `config` 对象即可进入 callback；`invokeProvider` callback 负责 fallback 到 `globalProviderRef`

**根本问题二**：`icee:list-runs` IPC handler 注册在 `initRuntime()` 内（异步延迟执行），但 renderer 在启动时立即调用，导致 `No handler registered for 'icee:list-runs'` 报错。

**修复内容二**：
- `apps/desktop/src/main/index.ts`：在 `registerProviderHandlers()` 中提前注册 `icee:list-runs`（早期版本，DB 就绪时返回历史，否则返回空数组）；`initRuntime` 就绪后通过 `removeHandler` + 重新 `handle` 覆盖为真实数据版本

---

### v0.3.2 — 垂直滚动列表 + 全宽扁平节点 + NodeConnector + taskPreview + AI 结果内嵌

**改动内容**：

- **`types/ui.ts` — SubagentNode 增加 `taskPreview?: string`**：
  - 节点开始执行前显示一句话角色说明，帮助用户理解当前步骤意图

- **`App.tsx` — NODE_ID_PREVIEW_MAP + taskPreview 写入**：
  - 新增模块级常量 `NODE_ID_PREVIEW_MAP`（每个节点 ID 对应一句话说明）
  - `onStepEvent` 中创建节点时写入 `taskPreview`（首次出现时设置，后续更新不覆盖）

- **`SubagentCard.tsx` — 全宽扁平卡片（v0.3.2 重构）**：
  - 从固定 192px 宽改为 `w-full` 全宽横向扁平卡片
  - 左侧 3px 彩色竖条替代顶部 2px 光条，更直观区分节点类型
  - idle/running 初始状态在卡片内容区显示 `taskPreview` 任务概览
  - 展开条件放宽：`canExpand = hasSteps && status !== "idle"`（running 中也可展开）
  - 优化了状态信息横向排列布局（类型 badge + 状态点 + 状态文字）

- **`NerveCenter.tsx` — 垂直滚动列表（v0.3.2 重构）**：
  - 移除 `useDraggableCanvas`、`useLayoutEngine`、`computeRoundLayouts` 等画布相关逻辑
  - 移除所有 SVG 连线（`DataPipeSvgPath`、`DataPipe` 等）
  - 移除 `overflow-hidden + transform 拖拽` 容器
  - 中间区域改为 `overflow-y-auto` 垂直滚动列表，节点按拓扑顺序从上到下排列
  - 新增内联 `NodeConnector` 组件：替代 SVG 连线，用竖线 + 箭头表示节点流向
    - pending=灰 / active=蓝（流动小球）/ completed=绿 / failed=红
  - `deriveDisplayNodes` 新函数：BFS 拓扑排序推导当前应显示的节点及其连接 edge
  - AI 最终回复 (`AiOutputCard`) 移至节点列表末尾内嵌显示（不再在顶部）
  - 历史轮次半透明显示，带轮次标签（轮号 + 任务摘要）

---

### v0.3.1 — 执行器修复 + 节点颜色 + 动画优化 + 上下文压缩提示

**修复内容**：

- **`packages/core/src/executor/builtins/MemoryNodeExecutor.ts`**：
  - 完全重写：从键值读写型改为 LLM 调用型，接受 `invokeProvider` 依赖注入
  - 行为与 `LLMNodeExecutor` 完全一致，读取 `config.systemPrompt/promptTemplate/temperature/maxTokens`
  - 修复 `Memory node "decompose" missing key config` 崩溃

- **`packages/core/src/executor/builtins/PlanningNodeExecutor.ts`**：
  - 完全重写：从静态计划生成改为 LLM 调用型，接受 `invokeProvider` 依赖注入
  - 修复规划节点无法真正理解任务、只返回固定结构的问题

- **`packages/core/src/executor/builtins/ReflectionNodeExecutor.ts`**：
  - 完全重写：从固定返回"acceptable"改为 LLM 调用型，接受 `invokeProvider` 依赖注入
  - 修复反思节点无法真正审查质量的问题

- **`apps/desktop/src/main/index.ts`**：
  - 提取 `sharedInvokeProvider` 闭包（原 `LLMNodeExecutor` 的内联闭包），供四种节点类型共用
  - `PlanningNodeExecutor`、`MemoryNodeExecutor`、`ReflectionNodeExecutor` 注册时传入 `sharedInvokeProvider`
  - 删除原来的空壳 `PlanningNodeExecutor`/`ReflectionNodeExecutor` 注册

- **`apps/desktop/src/renderer/App.tsx`**：
  - 新增模块级 `NODE_ID_TYPE_MAP`（节点 ID → 类型映射）和 `NODE_ID_LABEL_MAP`（节点 ID → 友好标签）
  - `onStepEvent` 中查表获取正确的节点 `type`，修复所有节点显示为蓝色（LLM）的问题
  - `onTokenUpdate` 中加入上下文压缩预警：token 超过 3000 时自动追加 SYSTEM 日志

- **`apps/desktop/src/renderer/components/nerve-center/NerveCenter.tsx`**：
  - 动画 delay 从 `idx * 0.04s`（数组下标）改为 `pos.level * 0.12s`（BFS 层级）
  - 同层节点（如 Context 和 Executor）同时出现，不同层按层级错落出现

- **`apps/desktop/src/renderer/components/nerve-center/TraceLogDrawer.tsx`**：
  - 上下文压缩警告条目特殊样式：金色左边框 + 金色背景 + 金色文字，醒目区分

---

### v0.3.0 — 链式思考 Agent 图 + 钻石布局 + 双语提示词

**新增内容**：

- **`packages/core/src/executor/builtins/LLMNodeExecutor.ts`**：
  - 修复 `renderTemplate`：当 `previousOutput` 为字符串时，`{{output.text}}` 现在正确返回该字符串（而非空字符串），解决多节点链式传递断链问题

- **`apps/desktop/src/renderer/i18n/translations.ts`**：
  - 新增 `agentPrompts` 分组（中英双语），包含 4 个 Agent 节点的完整 `systemPrompt` + `promptTemplate`：
    - `planner`：任务分解为3步（规划专家角色）
    - `context`：提取技术要点和约束（上下文分析专家角色）
    - `executor`：生成完整可交付内容（执行专家角色）
    - `reflector`：质量审查+整合优化（质检专家角色）
  - 提示词遵循 **Role + Rules + Template** 三段式结构，参考业界最佳实践

- **`apps/desktop/src/renderer/main.tsx`**：
  - 将 `LanguageProvider` 从 `App.tsx` 内部提升到 `main.tsx`，使 `App` 函数可直接调用 `useLanguage()` hook

- **`apps/desktop/src/renderer/App.tsx`**：
  - 引入 `useLanguage` hook，在组件顶层获取 `t`
  - `handleTaskSubmit` 中的 `graphJson` 从原来3节点扩展为 **6节点链式思考图**：
    - `input(INPUT)` → `plan(PLANNING)` → `decompose(MEMORY)` → `execute(LLM)` → `reflect(REFLECTION)` → `output(OUTPUT)`
    - 各节点配置各自的 `systemPrompt`/`promptTemplate`，自动跟随系统语言切换中英文
    - Executor 节点 `maxTokens` 提升到 2048，Reflector 同样 2048

- **`apps/desktop/src/renderer/hooks/useLayoutEngine.ts`**：
  - 新增 `X_BIAS` 横向偏移表，实现**钻石形扩散布局**：
    - `decompose`（Context）向左偏移 -150px
    - `execute`（Executor）向右偏移 +150px
  - `LEVEL_H` 从 160 调整为 150px（更紧凑）

- **`apps/desktop/src/renderer/components/nerve-center/SubagentCard.tsx`**：
  - 新增 `TYPE_ACCENT` 颜色表（紫/青/蓝/金/玫红）
  - 每个节点卡片顶部增加 **2px 彩色标识光条**，颜色对应节点类型
  - Running 时的流光条叠加在光条之上（z-index: 2），视觉层次更清晰

- **`apps/desktop/src/renderer/components/nerve-center/NerveCenter.tsx`**：
  - 新节点出现动画改为**从父节点位置滑出**：
    - 计算父节点（source edge）的 Y/X 坐标差，作为 `initial.y/x` 偏移
    - 节点按 `idx * 40ms` 错落出现，避免同时弹出的突兀感
    - 同时更新单轮动态图和多轮历史图的动画逻辑

---

### v0.2.11 — IPC 早期占位 + Framer Motion 警告修复

**修复内容**：
- **`apps/desktop/src/main/index.ts`**：
  - 在 `registerProviderHandlers()` 中提前注册 `icee:run-graph`、`icee:cancel-run`、`icee:fork-run` 占位 handler（runtime 未就绪时返回友好错误信息，而不是 "No handler registered" 崩溃）
  - `initRuntime` 就绪后通过 `removeHandler` + 重新 `handle` 替换为真实实现
- **`apps/desktop/src/renderer/components/layout/Sidebar.tsx`**：
  - 将 `NavItem` 和 `SessionItem` 组件中 `style.background: "transparent"` 改为 `"rgba(0,0,0,0)"`，`border: "1px solid transparent"` 改为 `"1px solid rgba(0,0,0,0)"`，解决 Framer Motion `whileHover` 动画警告
- **`apps/desktop/src/renderer/components/nerve-center/TaskInputBar.tsx`**：
  - 回形针按钮初始 `style` 补充 `background: "rgba(0,0,0,0)"`，配合 `whileHover` 渐变不报警告
  - 模型下拉列表项 `background: isSelected ? "rgba(...)" : "transparent"` 改为 `"rgba(0,0,0,0)"`，`onMouseLeave` 对应更新

---

### v0.2.10 — baseUrl /v1 修复 + 调试日志

**修复内容**：
- **`packages/providers/src/adapters/OpenAICompatibleProvider.ts`**：
  - 新增 `private get normalizedBaseUrl()` 确保 baseUrl 末尾包含 `/v1`，修复 LM Studio 404 问题
- **`packages/core/src/executor/builtins/LLMNodeExecutor.ts`**：
  - 新增 debug 日志输出 `systemPrompt`、`promptTemplate`（渲染前/后）、`globalInput`

---

### v0.3.4 — 打包支持 + 内置 MCP/Skills

**核心改动**：

1. **静态 import 修复**（`apps/desktop/src/main/index.ts`）：
   - 将所有 `await import(...)` 改为顶部静态 import
   - 解决打包后动态路径失效问题

2. **electron-builder 配置**（`apps/desktop/package.json`）：
   - 新增完整的 `build` 字段（appId、productName、目录、asarUnpack 等）
   - `asarUnpack` 包含：server-filesystem、MCP SDK、better-sqlite3
   - Windows NSIS 安装包配置（可选安装路径、桌面快捷方式）

3. **内置 MCP 工具集**（`apps/desktop/src/main/mcp/BuiltinMcpTools.ts`，全新）：
   - `web_search`：DuckDuckGo 搜索（无 API Key）
   - `http_fetch`：抓取任意 URL 文本内容
   - `browser_open`：系统默认浏览器打开 URL
   - `clipboard_read`：读取剪贴板文本
   - `clipboard_write`：写入剪贴板文本
   - Agent 工具调用优先级：内置工具 > MCP filesystem server

4. **内置 Agent Skills**（`packages/core/src/skills/AgentSkills.ts`，全新）：
   - `ContextCompressor`：上下文超出 80% token 时自动压缩历史消息
   - `RetryWithBackoff`：LLM 调用失败时指数退避自动重试（2次）
   - `OutputFormatter`：格式化最终输出（修复代码块、规范空行）
   - `WebSearchSkill`：DuckDuckGo Instant Answer API 快速搜索

5. **图标资源**（`apps/desktop/build-resources/icon.ico`）：
   - 应用打包图标

---

### v0.2.9 — 输入框模型选择器

**新增功能**：在 agent 输入框右侧新增模型下拉选择器。

**改动文件**：
- **`TaskInputBar.tsx`**：
  - 新增 `providers`、`selectedModel`、`onModelChange` props
  - 右侧（发送按钮左侧）加入紧凑下拉按钮，显示当前模型名（截断）+ 蓝点
  - 点击展开浮层菜单，列出所有 provider 的 model 选项（Framer Motion 动画）
  - 提交时把 `selectedModel` 作为第三参数传给 `onSubmit`
- **`NerveCenter.tsx`**：
  - 新增 `providers`、`selectedModel`、`onModelChange` props，透传给 `TaskInputBar`
- **`App.tsx`**：
  - 新增 `selectedModel` state（`useState<string | undefined>(undefined)`）
  - `handleTaskSubmit` 新增 `modelOverride?: string` 参数，写入 graphJson LLM node config
  - 向 `NerveCenter` 传入 `providers`、`selectedModel`、`onModelChange={setSelectedModel}`

---

### v0.2.8 — Provider DB 彻底修复

**根本原因（三个叠加 bug）**：
1. `app.getPath("userData")` 路径不固定（开发模式下为 `Electron`，打包后为 `@icee\desktop`），每次写入不同 DB 文件
2. `OpenAICompatibleProvider` 构造函数缺少必填 `id`/`name` 字段，传了不存在的 `defaultModel`
3. `constructor.name` vs DB `type` 字符串比较永远不等，导致每次都重建实例（实际无害，但逻辑混乱）

**修复内容**：
- **`apps/desktop/src/main/index.ts`**：
  - `app.setPath("userData", ...)` 在 `whenReady` 最顶部强制设置为 `Roaming\ICeeAgent`，统一开发/生产路径
  - 新增 `fs` 导入
  - `ensureEarlyDb()` 中加入从旧路径（`Electron\`、`@icee\desktop\`）自动迁移 provider 数据逻辑（`ATTACH DATABASE` + `INSERT OR IGNORE`）
  - 新增 `getEffectiveDefaultProvider()` 辅助函数：优先返回 `is_default=1`，否则 fallback 任意第一条并自动设为默认
  - 所有创建 `OpenAICompatibleProvider` 的地方统一传入 `id`/`name`，删除不存在的 `defaultModel`
  - `globalProviderRef` 新增 `type: string` 字段，替换 `constructor.name` 比较
  - `save-provider` 新增"唯一 provider 自动设为默认"逻辑

---

### v0.2.4 — Provider 持久化彻底修复

**根本问题**：`SettingsPage` 每次路由切换被 React 卸载重挂载，`useState(mockProviders)` 回到初始值，配置丢失。

**修复内容**：
- **`App.tsx`**：
  - 新增 `providers: ProviderConfig[]` state（初始空数组，不用 mock）
  - 新增 `useEffect` 在 Electron 下调用 `listProviders` IPC，结果写入 state；非 Electron fallback `mockProviders`
  - 新增 `handleSaveProvider`（乐观更新 + IPC 写 DB + reloadProvider 热重载）
  - 新增 `handleDeleteProvider`（乐观更新 + IPC 删除）
  - 向 `SettingsPage` 传入 `providers`、`onSaveProvider`、`onDeleteProvider` props
- **`SettingsPage.tsx`**：
  - 组件签名改为接受 `providers`、`onSaveProvider`、`onDeleteProvider` props
  - 删除内部 `providers` useState 和 `listProviders` useEffect
  - 删除内部 `handleSaveProvider` / `handleDeleteProvider`，改用 props 回调
  - 移除 `mockProviders` 导入（不再需要）

---

### v0.2.1 — 全面打通

- `forkRun` IPC 接通（preload/main/renderer）
- 真实 MCP 工具数据接入
- 空画布引导提示

### v0.2.0 — 节点展开/撤回/重跑

- `NodeDetailPanel.tsx`、`RerunModal.tsx` 新增
- `SubagentCard` 可展开显示步骤历史

### v0.1.9 — 动态图可视化

- `ExecutionEdge` 接口、`useLayoutEngine` BFS 布局
- `DataPipe` SVG 贝塞尔曲线动画连线

### v0.1.8 — 真实数据打通

- IPC 事件驱动 trace log、subagents、orchestrator 状态

### v0.1.7 — MCP + 文件/图片上传

### v0.1.6 — 多会话 UI + Electron IPC

### v0.1.5 — Ollama CLI 接入

### v0.1.0 — 初始实现

---

## 关键类型（types/ui.ts）

| 类型 | 说明 |
|------|------|
| `ExecutionRound` | 单轮对话执行图（roundIndex, task, edges, subagents, aiOutput） |
| `ConversationSession` | 会话（含 `rounds: ExecutionRound[]`，向下兼容顶层字段） |
| `SubagentNode` | 单个执行节点状态 |
| `ExecutionEdge` | 有向执行边（pending/active/completed/failed） |
| `NodeStepRecord` | 节点内单步执行记录（供展开面板使用） |
| `TraceLogEntry` | Trace 日志条目 |

---

## 关键 IPC 通道

| 通道 | 方向 | 说明 |
|------|------|------|
| `icee:run-graph` | invoke | 执行图 |
| `icee:fork-run` | invoke | Fork 重跑 |
| `icee:reload-provider` | invoke | 热重载 Provider 配置 |
| `icee:save-provider` | invoke | 保存 Provider 到 DB |
| `icee:list-providers` | invoke | 列出所有 Providers |
| `icee:step-event` | on（主→渲染） | 步骤事件推送 |
| `icee:run-completed` | on（主→渲染） | Run 完成推送 |
| `icee:ollama-status` | on（主→渲染） | Ollama 健康状态推送 |
